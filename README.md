## CorpRAG UI (demo)

UI‑прототип корпоративного RAG‑сервиса (React + TypeScript + Tailwind). Проект **полностью клиентский**: данные и «API» живут в `src/services/mockService.ts`, поэтому подходит для быстрого UX/Trust‑layer прогона и онбординга команды.

### Зачем это сделано

- **UX прототип**: проверить основные сценарии (чат → источники → доверие → админ/наблюдаемость → знания).
- **Trust‑layer**: показать пользователю источники, дать управление доступом и собрать обратную связь по качеству ответа.
- **База под реальную интеграцию**: мок‑методы и типы можно заменить на реальные API без переписывания UI.

---

## Онбординг (5 минут)

### Установка и запуск

```bash
npm install
npm start
```

Открой `http://localhost:3000`.

Если порт занят:

```bash
npm start -- --port 3001
```

### Куда смотреть в UI

- **Чат** (`/chat`)
  - слева: вкладки **Чаты / Коллекции**, поиск по чатам, кнопка **Новый чат**, удаление чата через троеточие
  - центр: диалог + **IVR быстрые вопросы внутри тела чата**
  - справа: **Источники / Поиск / Сессия**
    - топ‑источник №1 со стикером **«Лучшее совпадение»**
    - клик по источнику → **popup** с кнопками копирования и перехода по ссылке
    - лайк на ответ ассистента (зелёный) + подтверждение на 2 секунды
- **Знания** (`/knowledge`)
  - загрузка файлов (multi‑upload) с **прелоадером по количеству/прогрессу/времени**
  - таблица документов с колонками **Источник** и **Доступ**
  - клик по документу → панель управления доступом (source‑managed vs manual)
- **Активность** (`/dashboard`)
  - линейный график активности, donut по оценке полезности (помог/не помог)
- **Админ** (`/admin`)
  - вкладки: **Журнал / Неотвеченные / Политики / Аудит**
  - «Неотвеченные»: группировка вопросов по частоте, чтобы ответственный за наполнение мог реагировать

---

## User Guide (как работает RAG для сотрудника)

Этот раздел описывает **фактический UX**, который уже реализован в прототипе.

### 1) Выбор контекста: коллекции

В `Чат → Коллекции` выбери, по каким коллекциям делать поиск. Это влияет на:

- **retrieval** (что будет найдено в базе)
- **sources** (какие документы покажутся справа)
- **контроль утечек**: если коллекция не выбрана — контент из неё не должен попадать в ответ

### 2) Отправка вопроса

В центре (чат):

- можно написать вопрос вручную
- либо использовать **IVR / быстрые вопросы** внутри тела чата (удобно для демо)

Параметры в композере:

- **Стиль (Кратко/Подробно)**: влияет на «формат» ответа
- **Top‑K**: сколько фрагментов/источников подтягивать (в демо влияет на количество источников)
- **Строго по источникам**: в демо это UI‑переключатель, в реальной системе он должен усиливать grounding‑поведение

### 3) Что происходит после отправки

В UI моделируются фазы:

- `Searching…` → `Generating…` → `Streaming…`

После завершения:

- ответ появляется в чате
- справа (вкладка **Источники**) появляются top‑источники

### 4) Как читать и проверять источники (trust-layer)

Справа, вкладка **Источники**:

- показывается **топ 5** источников
- у источника №1 есть стикер **«Лучшее совпадение»**
- клик по источнику открывает **popup** со сниппетом + действия:
  - **Скопировать** цитату
  - **Открыть** ссылку (если есть)

В тексте ответа:

- есть кликабельные маркеры цитат `[1]`, `[2]`, …
- клик по цитате переводит фокус на вкладку Sources (trust‑flow)

### 5) Быстрая валидация ответа пользователем

У сообщения ассистента есть кнопка **лайка**:

- при лайке кнопка становится **зелёной**
- на 2 секунды появляется подтверждение “ответ учтён как корректный”

Цель: собрать «сигнал качества» от пользователей (для аналитики/обучения/приоритезации пробелов в базе знаний).

### 6) Работа с чатами как сессиями

Слева, вкладка **Чаты**:

- список чатов (моки), названия формируются из первых слов вопроса
- есть поиск **по названию и по содержимому**
- **Новый чат** — основное действие
- удаление чата: hover → троеточие → **Удалить чат** → подтверждение

### 7) Индикатор «новый ответ»

Если ты отправил вопрос, ушёл на другую вкладку (например, «Знания»), а ответ сформировался:

- на пункте меню **Чат** появляется бейдж с количеством новых ответов
- при заходе на `/chat` счётчик сбрасывается

---

## Admin Guide (как работает RAG для ответственного за наполнение/безопасность)

### 1) Где управлять документами

Раздел **Знания** (`/knowledge`):

- коллекции (create/rename/delete)
- загрузка документов (multi‑upload) с прелоадером по времени/количеству
- таблица документов

### 2) Разграничение доступа (ACL)

В таблице документов есть колонки:

- **Источник**: `Confluence / SharePoint / Загрузка`
- **Доступ**: метка уровня доступа

Клик по документу открывает панель «Доступ к документу»:

- для Confluence/SharePoint:
  - ✅ «Доступ управляется в источнике»
  - есть «Последняя синхронизация» + кнопка **Пересинхр.**
  - ручная правка отключена (это принцип “доступ наследуется от источника”)
- для загруженных документов (PDF/DOCX/…):
  - режим **Автоматический** (заготовка под rules/metadata) или **Ручной**
  - ручной доступ поддерживает:
    - пользователя (email)
    - группу
    - роль
    - «все сотрудники» (internal public)

Важно: уже сейчас в демо‑логике `mockService.sendChat()` источники **фильтруются по ACL и политикам**.

### 3) Работа с неотвеченными запросами

В **Админ → Неотвеченные**:

- вопросы агрегируются по тексту и сортируются по **частоте**
- это список «пробелов в базе знаний» для приоритезации загрузки документов
- есть кнопка перехода в **Знания**

### 4) Политики безопасности

В **Админ → Политики**:

- доступ по умолчанию для загруженных документов
- блок документов с тегом `confidential` в RAG
- опция «требовать подтверждённый email»

### 5) Аудит

В **Админ → Аудит**:

- логируются события:
  - включение документов в источники RAG (`rag_source_used`)
  - изменение доступа (`doc_access_changed`)
  - пересинхронизация (`doc_resynced`)

Цель: compliance/разбор инцидентов/трассировка «почему этот документ попал в ответ».

---

## Что реализовано (high level)

### Адаптивность

- мобильный режим: боковые панели в чате открываются drawer’ами, хедер — через мобильное меню

### Чаты (сессии)

- список чатов + поиск по названию/содержимому, моковые сессии
- удаление чата через hover‑меню + подтверждение
- индикатор непрочитанных ответов на пункте меню «Чат», если ответ пришёл пока пользователь на другой вкладке

### Trust‑layer: источники и обратная связь

- топ‑источник со стикером «Лучшее совпадение»
- popup источника
- лайк на ответ ассистента + подтверждение

### Знания и загрузка

- загрузка файлов в коллекцию с прогрессом и временем

### Разграничение доступа (ACL) — демо‑реализация

Основные принципы:

- **Наследование от источника** (`Confluence/SharePoint`): режим `source` (только ресинк, без ручной правки)
- **Ручной доступ** для `upload` (PDF/DOCX/…): пользователь/группа/роль/все сотрудники (read‑only для RAG)
- **Политики**: дефолтный доступ для upload, блок `confidential` в RAG, require verified email (в демо включается политикой)
- **Аудит**: события выдачи источников в RAG, изменения доступа, ресинк

Важно: это **мок**, но уже встроен в UX: `mockService.sendChat()` фильтрует источники по ACL.

### Админ: неотвеченные запросы

- вкладка «Неотвеченные»: агрегирование по частоте и сортировки (частота/недавние)

---

## Команды

```bash
npm start
npm run build
npm test
```

---

## Структура проекта

```
src/
├── components/          # React компоненты
│   ├── Layout.tsx      # Основной layout с навигацией
│   ├── ChatLayout.tsx  # Layout для страницы чата
│   └── chat/           # Компоненты чата
│       ├── CollectionsSidebar.tsx
│       ├── ChatSessionsSidebar.tsx
│       ├── ChatThread.tsx
│       ├── MessageBubble.tsx
│       ├── Composer.tsx
│       ├── RightPanel.tsx
│       ├── SourcesPanel.tsx
│       ├── RetrievalPanel.tsx
│       └── SessionPanel.tsx
├── pages/              # Страницы приложения
│   ├── ChatPage.tsx
│   ├── KnowledgePage.tsx
│   ├── DashboardPage.tsx
│   └── AdminPage.tsx
├── services/           # Сервисы
│   └── mockService.ts  # Мок-сервис с имитацией API
├── contexts/           # React контексты
│   └── ChatContext.tsx # Контекст для управления состоянием чата
├── types.ts            # TypeScript типы
└── App.tsx             # Главный компонент с роутингом
```

---

## Технологии

- **React** + **TypeScript**
- **CRA (react-scripts)**, **React Router**
- **Tailwind CSS**
- **lucide-react**, **react-markdown**

## Ограничения демо

- всё в памяти (перезагрузка страницы сбрасывает состояние)
- «интеграции» Confluence/SharePoint — мок‑логика (но UX и модель ACL уже заложены)
